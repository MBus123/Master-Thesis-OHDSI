<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writing Hydra configuration files • Hydra</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Writing Hydra configuration files">
<meta property="og:description" content="Hydra">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Hydra</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/HydratingPackages.html">Hydrating packages</a>
    </li>
    <li>
      <a href="../articles/WritingHydraConfigs.html">Writing Hydra configuration files</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/Hydra/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="WritingHydraConfigs_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="WritingHydraConfigs_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="WritingHydraConfigs_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Writing Hydra configuration files</h1>
                        <h4 class="author">Martijn J. Schuemie</h4>
            
            <h4 class="date">2020-11-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/Hydra/blob/master/vignettes/WritingHydraConfigs.Rmd"><code>vignettes/WritingHydraConfigs.Rmd</code></a></small>
      <div class="hidden name"><code>WritingHydraConfigs.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette describes how developers of package skeletons can write Hydra configuration files. Hydra configuration files tell Hydra how to hydrate the skeleton according to a study specifications object. The Hydra configuration file should be embedded in the skeleton zip file.</p>
<div id="study-specifications" class="section level2">
<h2 class="hasAnchor">
<a href="#study-specifications" class="anchor"></a>Study specifications</h2>
<p>The study specifications are generated by some external editor, such as ATLAS. Study specifications will be in JSON format. The specifications will define every aspect of the study, such as the cohorts to use as exposures and outcomes, and what covariates to include. Here are the first few lines of an example study specification:</p>
<pre><code>{
    "id": 1,
    "version": "v0.9.0",
    "name": "Study of some cohorts of interest",
    "packageName": "ASimpleStudy",
    "skeletonType": "SimpleExampleStudy",
    "skeletonVersion": "v0.0.1",
    "createdBy": "schuemie@ohdsi.org",
    "createdDate": "2018-03-09T18:25:43.511Z",
    "modifiedBy": "schuemie@ohdsi.org",
    "modifiedDate": "2018-04-13T18:25:43.511Z",
    "cohortDefinitions": [{
            "id": 1,</code></pre>
</div>
<div id="package-skeleton" class="section level2">
<h2 class="hasAnchor">
<a href="#package-skeleton" class="anchor"></a>Package skeleton</h2>
<p>A package skeleton is an R package for fully executing a specific type of study, such as a new-user cohort study or a predictive modeling study. The skeleton has placeholders for study elements such as those specified in the study specifications. Package skeletons are provided as zip files, and are embedded inside Hydra (see the <code>inst/skeletons</code> folder) .</p>
</div>
<div id="hydration" class="section level2">
<h2 class="hasAnchor">
<a href="#hydration" class="anchor"></a>Hydration</h2>
<p>By hydration we mean the process by which the package skeleton is configured according to the study specification to become a fully executable study package. A study package will perform all tasks necessary to execute the study at a site, including creation of the cohorts needed in the study.</p>
</div>
</div>
<div id="hydration-configuration-file-example" class="section level1">
<h1 class="hasAnchor">
<a href="#hydration-configuration-file-example" class="anchor"></a>Hydration configuration file example</h1>
<p>The hydration configuration is a JSON file. Below is an example configuration:</p>
<pre><code>{
    "skeletonType": "SimpleExampleStudy",
    "skeletonVersion": "v1.0.0",
    "requiredHydraVersion": "v0.0.1",
    "actions":[{
        "type": "fileNameFindAndReplace",
        "input": "packageName",
        "find": "SimpleExampleStudy"
    },{
        "type": "stringFindAndReplace",
        "input": "packageName",
        "find": "SimpleExampleStudy"
    },{
        "type": "jsonArrayToCsv",
        "input": "cohortDefinitions",
        "mapping": [{"source": "id", "target": "cohortId"},
                    {"source": "id", "target": "atlasId"},
                    {"source": "name", "target": "name", "modifiers": ["convertToFileName"]}],
        "output": "inst/settings/CohortsToCreate.csv"
    },{
        "type": "jsonArrayToJson",
        "input": "cohortDefinitions",
        "fileName": "name",
        "payload": "expression",
        "output": "inst/cohorts"
    },{
        "type": "jsonArrayToSql",
        "input": "cohortDefinitions",
        "fileName": "name",
        "payload": "expression",
        "output": "inst/sql/sql_server"
    }]
}</code></pre>
<p>The configuration consists of some meta data such as “skeletonType”, followed by an array of actions. In this example, there are 5 actions that will be executed by Hydra in sequence after unzipping the skeleton:</p>
<ol style="list-style-type: decimal">
<li>Find all files named <code>SimpleExampleStudy.*</code>, and rename them to the name specified in the “packageName” attribute in the study specifications (while keeping the same extention).</li>
<li>Find all mentions of the string <code>SimpleExampleStudy</code> in all files in the package folder, and replace it with the string specified in the “packageName” attribute in the study specifications.</li>
<li>Create a CSV file called <code>inst/settings/CohortsToCreate.csv</code>, and populate it with the elements from the <code>cohortDefinitions</code> array in the study specifications.</li>
<li>Create JSON files in the <code>inst/cohorts</code> folder, one for each element in the <code>cohortDefinitions</code> array in the study specifications.</li>
<li>Create SQL files in the <code>inst/sql/sql_server</code> folder, one for each element in the <code>cohortDefinitions</code> array in the study specifications. The SQL is generated by Hydra using Circe.</li>
</ol>
</div>
<div id="conditions" class="section level1">
<h1 class="hasAnchor">
<a href="#conditions" class="anchor"></a>Conditions</h1>
<p>Each action can be made conditional by adding a <em>condition</em> field. For example, in this configuration the <code>jsonToArgs</code> action is only executed if the <code>doPositiveControlSynthesis</code> field in the study specifications resolves to the value ‘true’ (or ’1).</p>
<pre><code>{
        "type": "jsonToRargs",
        "input": "positiveControlSynthesisArgs",
        "condition": "doPositiveControlSynthesis",
        "file": "R/SynthesizePositiveControls.R",
        "startTag": "# Start positiveControlSynthesisArgs",
        "endTag": "# End positiveControlSynthesisArgs"
}</code></pre>
<p>Boolean logic is also permitted in condition fields. Here are some more examples of conditions:</p>
<pre><code>"(mainSettings.subsetting.type == 'foo') &amp; bar != 3"
"fooOption IN ('bar', 'pie', 'sky')"
"(foo == 1) | (bar == 2)"</code></pre>
</div>
<div id="action-types" class="section level1">
<h1 class="hasAnchor">
<a href="#action-types" class="anchor"></a>Action types</h1>
<p>Below all available action types and their arguments are described. Whenever an element in the study specification is referenced, nested elements can be accessed by using a dot (‘.’). For example, “estimationAnalysisSettings.analysisSpecification” returns the <code>analysisSpecification</code> element of the <code>estimationAnalysisSettings</code> root element.</p>
<div id="filenamefindandreplace" class="section level2">
<h2 class="hasAnchor">
<a href="#filenamefindandreplace" class="anchor"></a>fileNameFindAndReplace</h2>
<p>Finds all files with the given name, and renames them to a target name (while maintaining the file extension).</p>
<p>Arguments:</p>
<ul>
<li>
<em>input</em>: The path to the element in the study specification containing the target name.</li>
<li>
<em>find</em>: The name to look for. Extensions should not be included.</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
</ul>
</div>
<div id="stringfindandreplace" class="section level2">
<h2 class="hasAnchor">
<a href="#stringfindandreplace" class="anchor"></a>stringFindAndReplace</h2>
<p>Finds all mentioned of a string in all files in the package, and replaces them with a target string.</p>
<ul>
<li>
<em>input</em>: The path to the element in the study specification containing the target string</li>
<li>
<em>find</em>: The string to look for.</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
<li>
<em>exclude</em>: Optional: file mask to exclude conforming filenames from action execution, it could a single string or an array of strings. For example, <code>*.jar</code> excludes all jar files.</li>
</ul>
</div>
<div id="jsonarraytocsv" class="section level2">
<h2 class="hasAnchor">
<a href="#jsonarraytocsv" class="anchor"></a>jsonArrayToCsv</h2>
<p>Convert an array in the study specifications to a CSV file in the package, where each element of the array will generate one row in the CSV file.</p>
<ul>
<li>
<em>input</em>: The path to the array in the study specifications.</li>
<li>
<em>mapping</em>: An array of objects with the following elements:
<ul>
<li>
<em>source</em>: The name of the element to pull from the array element in the study specification</li>
<li>
<em>target</em>: The name of the column in the CSV file.</li>
<li>
<em>separator</em>: Optional: if the source element is itself an array, what separator should be used to collapse that array into a single string?</li>
<li>
<em>modifiers</em>: Optional: modifiers to be applied to the source value before entering in the CSV. This should be an array of strings, with these possible values:
<ul>
<li>
<em>convertToFileName</em>: Make the source string suitable for creating file names.</li>
</ul>
</li>
</ul>
</li>
<li>
<em>output</em>: The name of the CSV file to create.</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
</ul>
</div>
<div id="jsonarraytojson" class="section level2">
<h2 class="hasAnchor">
<a href="#jsonarraytojson" class="anchor"></a>jsonArrayToJson</h2>
<p>Convert an array in the study specifications to a set of JSON files in the package, where each element of the array will generate one JSON file.</p>
<ul>
<li>
<em>input</em>: The path to the array in the study specifications.</li>
<li>
<em>fileName</em>: The element inside the array element that will be used to generate the JSON file name. The source string will be modified to be made suitable for file names. The “.json” extention will automatically be added.</li>
<li>
<em>payload</em>: The element inside the array element that will be the content of the JSON file.</li>
<li>
<em>output</em>: The folder in the package where the JSON files will be written.</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
</ul>
</div>
<div id="jsonarraytosql" class="section level2">
<h2 class="hasAnchor">
<a href="#jsonarraytosql" class="anchor"></a>jsonArrayToSql</h2>
<p>Convert an array in the study specifications to a set of SQL files in the package, where each element of the array will generate one SQL file. SQL files are automatically generated using Circe.</p>
<ul>
<li>
<em>input</em>: The path to the array in the study specifications.</li>
<li>
<em>fileName</em>: The element inside the array element that will be used to generate the SQL file name. The source string will be modified to be made suitable for file names. The “.sql” extention will automatically be added.</li>
<li>
<em>payload</em>: The element inside the array element that will be converted to SQL.</li>
<li>
<em>output</em>: The folder in the package where the SQL files will be written.</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
</ul>
</div>
<div id="jsontosql" class="section level2">
<h2 class="hasAnchor">
<a href="#jsontosql" class="anchor"></a>jsonToSql</h2>
<p>Convert a single element in the study specifications to a SQL file in the package using Circe.</p>
<ul>
<li>
<em>input</em>: The path to the element in the study specifications.</li>
<li>
<em>expressionType</em>: Optional: The type of expression that is to be converted. Currently supports ‘cohort’ for generic cohort expressions, and ‘outcome’ for (negative control) outcome cohorts. If not specified, will default to ‘cohort’.</li>
<li>
<em>output</em>: The file in the package where the SQL will be written.</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
</ul>
</div>
<div id="jsontojson" class="section level2">
<h2 class="hasAnchor">
<a href="#jsontojson" class="anchor"></a>jsonToJson</h2>
<p>Convert a single element in the study specifications to a JSON file in the package.</p>
<ul>
<li>
<em>input</em>: The path to the element in the study specification containing the JSON to write to file.</li>
<li>
<em>output</em>: The name of the JSON file to create.</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
</ul>
</div>
<div id="jsontorargs" class="section level2">
<h2 class="hasAnchor">
<a href="#jsontorargs" class="anchor"></a>jsonToRargs</h2>
<p>Convert an element in the study specifications to R arguments.</p>
<ul>
<li>
<em>input</em>: The path to the element in the study specification that should be converted.</li>
<li>
<em>file</em>: The name of the existing R file in the package where the arguments should be inserted.</li>
<li>
<em>startTag</em>: The string in the R file that denotes the start location for inserting the arguments.</li>
<li>
<em>endTag</em>: The string in the R file that denotes the end location for inserting the arguments.</li>
<li>
<em>argumentFunctions</em>: An array of objects that defines what R functions to use to create nested arguments. These objects should have these elements:
<ul>
<li>
<em>source</em>: The name of the element that contains nested arguments</li>
<li>
<em>function</em>: The function to use in R to combine the nested arguments into a single argument.</li>
</ul>
</li>
<li>
<em>condition</em>: Optional: a condition that must be met to execute the action (see section on conditions).</li>
</ul>
<p>For example, imagine the study specifications contains this element:</p>
<pre><code>"args" : {
  "foo": "Hello",
  "bar": {
    "x": 123,
    "y": 456
  }
}</code></pre>
<p>And the Hydra configuration specifies:</p>
<pre><code>{
    "type": "jsonToRargs",
    "input": "args",
    "file": "R/fooBar.R",
    "startTag": "# Start fooBar",
    "endTag": "# End fooBar",
    "argumentFunctions": [{"source": "bar", "function": "createBar"}]
}</code></pre>
<p>If the original file fooBar.R in the skeleton contains:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">doFooBar</span><span class="op">(</span>
  <span class="co"># Start fooBar</span>
  foo <span class="op">=</span> <span class="st">"Bye"</span>,
  bar <span class="op">=</span> <span class="cn">NULL</span>
  <span class="co"># End fooBar</span>
<span class="op">)</span></code></pre></div>
<p>The hydrated fooBar.R will become:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">doFooBar</span><span class="op">(</span>
  foo <span class="op">=</span> <span class="st">"Hello"</span>,
  bar <span class="op">=</span> <span class="fu">createBar</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">123</span>,
                  y <span class="op">=</span> <span class="fl">456</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Martijn Schuemie, Jenna Reps, Anthony Sena.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
